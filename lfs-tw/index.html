
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://philsyme.github.io/lfs-tw/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.2">
    
    
      
        <title>LFS-TW - Phil's Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.24c991ad.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux-from-scratch-with-training-wheels" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Phil&#39;s Blog" class="md-header__button md-logo" aria-label="Phil's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Phil's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LFS-TW
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Phil&#39;s Blog" class="md-nav__button md-logo" aria-label="Phil's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Phil's Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          LFS-TW
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        LFS-TW
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lfs-using-virtual-machines" class="md-nav__link">
    LFS using Virtual Machines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lfs-on-vms-on-a-mac-m1-arm-64-cortex" class="md-nav__link">
    LFS on VMs on a Mac M1 (ARM 64 / Cortex)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overall-approach" class="md-nav__link">
    Overall Approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-1-before-you-start-the-lfs-book" class="md-nav__link">
    Supplemental Step 1: Before you start the LFS book:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-2-partitioning-the-lfs-disk" class="md-nav__link">
    Supplemental Step 2: Partitioning the LFS disk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-3-advice-on-a-custom-kernel" class="md-nav__link">
    Supplemental Step 3: Advice on a custom kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-4-installing-grub-and-uefi-booting-safely" class="md-nav__link">
    Supplemental Step 4: Installing GRUB and UEFI booting safely
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lfs-using-virtual-machines" class="md-nav__link">
    LFS using Virtual Machines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lfs-on-vms-on-a-mac-m1-arm-64-cortex" class="md-nav__link">
    LFS on VMs on a Mac M1 (ARM 64 / Cortex)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overall-approach" class="md-nav__link">
    Overall Approach
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#details" class="md-nav__link">
    Details
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-1-before-you-start-the-lfs-book" class="md-nav__link">
    Supplemental Step 1: Before you start the LFS book:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-2-partitioning-the-lfs-disk" class="md-nav__link">
    Supplemental Step 2: Partitioning the LFS disk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-3-advice-on-a-custom-kernel" class="md-nav__link">
    Supplemental Step 3: Advice on a custom kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplemental-step-4-installing-grub-and-uefi-booting-safely" class="md-nav__link">
    Supplemental Step 4: Installing GRUB and UEFI booting safely
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="linux-from-scratch-with-training-wheels">Linux From Scratch with Training Wheels</h1>
<p>or, "Linux from scratch using virtual machines on a Apple Mac M1 laptop"</p>
<h2 id="steps">Steps</h2>
<p>Working LFS hackers should probably read this article in reverse-section
order, just getting to the meat of things, and then reading the introductory
material for more context.</p>
<h2 id="introduction">Introduction</h2>
<p><a href="https://www.linuxfromscratch.org/lfs/">Linux from scratch</a> (LFS) is a 
<a href="https://www.linuxfromscratch.org/lfs/view/stable/">step-by-step
tutorial</a>
 for building your own Linux
distribution.  Using the LFS approach, you start with a major Linux distribution
that you prefer (e.g. Ubuntu) and bootstrap your own custom distribution.  Your final
LFS distribution will have nothing from the original distribution you started
your bootstrapping from.</p>
<p>LFS is an excellent learning tool even if you have been developing on or
administering Linux systems for a long time.  There is some kind of magic in
the "learning by doing" approach - your brain will pick up a bunch of
subtleties after you create a distribution where you, for example,  configure
every single aspect of the boot process.  LFS is also a really good way to
learn, in no particular order:</p>
<ul>
<li>
<p>Kernel hacking - you will have created the operating system around the
   kernel that you do hacking on, which indirectly helps you reason about
   custom kernels that you make.</p>
</li>
<li>
<p>Custom kernels - for the same reason above, you will get a deep
   understanding of why and how to customize a kernel</p>
</li>
<li>
<p>Building Linux software from source - yes, we all know how to run "make"
   and "make install" but, trust me, there's more to it than that.  If you
   want to level-up your knowledge on how to build packages on Linux this is a
   great way.</p>
</li>
<li>
<p>How to build cross-compilers - you will simulate the process of building
   a distribution targeting an entirely new machine.  This will include
   bootstrapping the entire GNU toolchain (gcc, libc, etc)</p>
</li>
</ul>
<h2 id="lfs-using-virtual-machines">LFS using Virtual Machines</h2>
<p>Today there's a stunningly great amount of open-source virtualization tools
for any operating system you are running, which allows you to perform the
steps in the LFS book in VMs.</p>
<p>This is a good thing because it lets you experiment with disk partitioning,
grub and the boot process (including UEFI), and rescuing your unbootable
distribution more easily than on your main box.</p>
<p>This approach I'm terming "LFS with Training Wheels".  Believe me if you
experiment enough and learn the concepts deeply, as part of that process you
will end up accidentally erasing disks, adding a typo to a critical boot
script, or other natural errors that turn out to be catastrophic.  In a
virtual environment you are almost always able to recover from any of these.
Learning to recover from them is good knowledge that you can apply in a "real"
environment.</p>
<h2 id="lfs-on-vms-on-a-mac-m1-arm-64-cortex">LFS on VMs on a Mac M1 (ARM 64 / Cortex)</h2>
<p>This blog post will show specifics on how to do all this on a Mac M1 laptop.
This is only for my convenience, hopefully all the steps here are easy to
translate to other host machines with the help of the Google machine.</p>
<h2 id="overall-approach">Overall Approach</h2>
<p>The approach described here, and it's not the only one that will work, just
one way, is to take the following steps:</p>
<ul>
<li>
<p>Run two guest VMs on your computer, one with a major Linux distribution,
   the second your custom LFS distribution.  We will pretend that the first
   guest running the major Linux distribution is a physical host computer.
   In the LFS book, you will need to mentally translate every time it talks
   about the host as the first guest VM.  Yes it's turtles all the way down.</p>
</li>
<li>
<p>The second guest will start just as a virtual disk image.  Think of adding
   a physical hard drive to your laptop/desktop and building a bootable Linux
   on that disk.  We will attach a blank, unformatted, raw virtual disk image
   to the first guest VM (our pretend host) to start, and built it into a
   working, independently bootable image.</p>
</li>
<li>
<p>We will play some games with virtual flash files / drives so that we can 
   safely play with grub and UEFI booting.  This will include, at key points,
   restoring a backup file after grub goes crazy formatting our first guest
   vm's boot partition.  There's slicker ways to do this, like making our
   first host vm dual-boot, but, our method will be simple.</p>
</li>
</ul>
<h2 id="details">Details</h2>
<p>This article augments the LFS book.  Give the book a skim now, then use the
steps here.</p>
<h2 id="supplemental-step-1-before-you-start-the-lfs-book">Supplemental Step 1: Before you start the LFS book:</h2>
<p>Create a guest VM using qemu that serves as the "host".  </p>
<p>On a Mac M1, as of this writing (October 2021), this <a href="https://gist.github.com/nrjdalal/e70249bb5d2e9d844cc203fd11f74c55">github gist</a>
 is the best guide. </p>
<p>At the end of the process, hopefully after your brand-new Ubuntu image is
bootable, you can create a final script to run your host VM:</p>
<p><em>start_host.sh</em>: (before second drive)</p>
<pre><code>qemu-system-aarch64 \
  -machine virt,accel=hvf,highmem=off \
  -cpu cortex-a72 -smp 8 -m 2G \
  -device virtio-gpu-pci \
  -device virtio-keyboard-pci \
  -drive &quot;format=raw,file=edk2-aarch64-code.fd,if=pflash,readonly=on&quot; \
  -drive &quot;format=raw,file=ovmf_vars.fd,if=pflash&quot; \
  -drive &quot;format=qcow2,file=virtual-disk.qcow2&quot; \
  -nic hostfwd=tcp:127.0.0.1:9922-0.0.0.0:22 \
  -nographic
</code></pre>
<p>This script, line by line:</p>
<ul>
<li>Starts the ARM64 CPU emulator (this will be different for you if not on a MAC
   1)</li>
<li>Uses the ARM Cortex A72 instruction set for the CPU (again specific to an
   M@), with 8 hyper-threaded cores an 2 gigs of memory</li>
<li>Includes a gpu device</li>
<li>Includes a keyboard device</li>
<li>Includes 2 flash drives to simulate UEFI booting</li>
<li>Include a hard drive for the machine</li>
<li>Allows localhost 9922 to be used to ssh into the device</li>
<li>Turns of the display, so everything is displayed in the terminal</li>
</ul>
<p>You can modify this step to use a different kind of virtualization if you
would like, for example VirtualBox.</p>
<p>Now we add a second blank drive that will become built out to be our LFS
distribution.</p>
<pre><code>qemu-img create -f qcow2 virtual-lfs-disk.qcow2 30G
</code></pre>
<p>Note we are reserving 30G for the drive, but it will only take up space that
is needed.</p>
<p>We add this disk to our start_host.sh script and we are on our way:</p>
<p><em>start_host.sh</em> : (now with second drive)</p>
<pre><code>qemu-system-aarch64 \
  -machine virt,accel=hvf,highmem=off \
  -cpu cortex-a72 -smp 8 -m 2G \
  -device virtio-gpu-pci \
  -device virtio-keyboard-pci \
  -drive &quot;format=raw,file=edk2-aarch64-code.fd,if=pflash,readonly=on&quot; \
  -drive &quot;format=raw,file=ovmf_vars.fd,if=pflash&quot; \
  -drive &quot;format=qcow2,file=virtual-disk.qcow2&quot; \
  -drive &quot;format=qcow2,file=virtual-lfs-disk.qcow2&quot; \
  -nic hostfwd=tcp:127.0.0.1:9922-0.0.0.0:22 \
  -nographic
</code></pre>
<p>At this point you should follow the LFS book until you get to 
<a href="https://www.linuxfromscratch.org/lfs/view/stable/chapter02/creatingpartition.html">Chapter 2.4 "Creating a new
partition"</a></p>
<h2 id="supplemental-step-2-partitioning-the-lfs-disk">Supplemental Step 2: Partitioning the LFS disk</h2>
<p>Once you reach <a href="https://www.linuxfromscratch.org/lfs/view/stable/chapter02/creatingpartition.html">2.4 "Creating a new
partion"</a> in the LFS book:</p>
<p>While SSH'ed into the VM (host VM) from step 1, as root, run the "cfdisk"
(curses-based fdisk tool) on <code>/dev/vdb</code> (<strong>NOT</strong> <code>/dev/vda</code>), like so:</p>
<pre><code>cfdisk /dev/vdb
</code></pre>
<p>Note that whatever mistakes you make will not affect the main hard drive
running your major Linux distribution.</p>
<p>I create 3 partitions:</p>
<ol>
<li>An "EFI" system partition 1M big (will eventually be <code>/boot/efi</code>)</li>
<li>A "Linux Filesystem" partion 200M big (will eventually be <code>/boot</code>)</li>
<li>A "Lunux Filesystem" partition with the rest of the disk (will
        eventually be <code>/</code>)</li>
</ol>
<p>As the books says, it's completely up to you how you want to partition the
disk.  One single partition over the whole disk will work fine for our
purposes, or you can add multiple partitions as described in the book.</p>
<p>I would advise experimenting with cfdisk, writing out a few partitions, nuking
them, rewriting a different set, just playing with it until you are
comfortable.</p>
<p>At this point the steps in 2.5 and above should work fine.</p>
<h2 id="supplemental-step-3-advice-on-a-custom-kernel">Supplemental Step 3: Advice on a custom kernel</h2>
<p>Take this step while on <a href="https://www.linuxfromscratch.org/lfs/view/stable/chapter10/kernel.html">Chapter 10.3 Linux-5.13.12</a>, where you create a kernel
for your new machine.</p>
<p>You can iteratively make lots of custom kernels after finding success once.
I would advise doing the minimum amout of customization at first.  Your
instinct will be to make the leanest, meanest kernel possible but hold off on
that for future iterations.</p>
<p>Just go with the defaults from "make menuconfig", and also add these drivers
to support qemu virtualization: (basically get all the major virtio drivers in)</p>
<pre><code>CONFIG_VIRTIO_INPUT=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_DRM_VIRTIO_GPU=m
</code></pre>
<h2 id="supplemental-step-4-installing-grub-and-uefi-booting-safely">Supplemental Step 4: Installing GRUB and UEFI booting safely</h2>
<p>Follow these steps in the next section <a href="https://www.linuxfromscratch.org/lfs/view/stable/chapter10/grub.html">10.4. Using GRUB to Set Up the Boot Process</a>.</p>
<p>This is the trickiest part.  We are going to:</p>
<ol>
<li>Backup our virtual flash drives for the working UEFI booting of our host VM
   (first, non LFS VM)</li>
<li>Install grub for UEFI, <em>destructively wiping out</em> our host flash drive</li>
<li>Copy this new flash for our new LFS VM, and create a qemu script to run our
   LFS machine</li>
<li>Swap our backup copy from step 1 so that our host VM still works</li>
</ol>
<p>Step 1: Back up boot flash drive:</p>
<ul>
<li>Shut down the host VM</li>
<li>in the directory with all of our qemu files:</li>
</ul>
<pre><code>cp ovmf_vars.fd ovmf_vars.fd.host
</code></pre>
<ul>
<li>Start the host VM</li>
</ul>
<p>Step 2: Install grub in UEFI mode</p>
<p>In <a href="https://www.linuxfromscratch.org/lfs/view/stable/chapter10/grub.html">LFS chapter 10.4</a>, Follow the link to <a href="https://www.linuxfromscratch.org/blfs/view/11.0/postlfs/grub-setup.html">Chapter 5 of the "Beyond Linux From Scratch"</a>
 to install UEFI booting using grub.  This will overwrite "ovmf_vars.fd" in
 our VM, (hence the backup step 1) </p>
<p>Step 3: Make a copy of the flash boot drive for LFS machine booting:</p>
<ul>
<li>Shut down the host VM</li>
<li>In the directory with all of our qemu file:</li>
</ul>
<pre><code>cp ovmf_vars.fd ovmf_cars.fd.lfs
</code></pre>
<p>You should be able to create a start script for your new LFS VM at this
point. Mine looks like this:</p>
<p><em>start_lfs.sh</em>: </p>
<pre><code>qemu-system-aarch64 \
  -machine virt,accel=hvf,highmem=off \
  -cpu cortex-a72 -smp 8 -m 2G \
  -device virtio-gpu-pci \
  -device virtio-keyboard-pci \
  -drive &quot;format=raw,file=edk2-aarch64-code.fd,if=pflash,readonly=on&quot; \
  -drive &quot;format=raw,file=ovmf_vars.fd.lfs,if=pflash&quot; \
  -drive &quot;format=qcow2,file=virtual-lfs-disk.qcow2&quot; \
  -nic hostfwd=tcp:127.0.0.1:9923-0.0.0.0:22 \
  -nographic
</code></pre>
<p>Step 4: Restore the Backup:</p>
<pre><code>cp ovmf_vars.fd.host ovmf_vars.fd
</code></pre>
<p>Other notes:</p>
<ul>
<li>There are some idiosyncrasies on the aarm64 architecture.  I won't go into
   too many details here, but this article is worth a careful read when you
   get to chapter 9.4, managing devices
   <a href="https://unix.stackexchange.com/questions/307390/what-is-the-difference-between-ttys0-ttyusb0-and-ttyama0-in-linux/367882">What is ttyama0?</a></li>
<li>Don't run both the host machine and LFS machine at the same time! (unless
   you remove the lfs drive from the host machine first.) </li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
      
        
        <a href="../about/" class="md-footer__link md-footer__link--next" aria-label="Next: About" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              About
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.e99e714c.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.bc35569b.min.js"></script>
      
    
  </body>
</html>